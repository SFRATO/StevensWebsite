---
/**
 * Service Areas Page
 * Interactive town discovery experience with search, market movers,
 * and data-rich town directory.
 */
import BaseLayout from '@layouts/BaseLayout.astro';
import TownSearchIsland from '@components/TownSearchIsland.tsx';
import MoversAndShakersSection from '@components/MoversAndShakersSection.astro';
import TownPreviewCard from '@components/TownPreviewCard.astro';
import MarketTypeBadge from '@components/MarketTypeBadge.astro';
import MarketReportForm from '@components/MarketReportForm.astro';
import { generateBreadcrumbSchema } from '@utils/schema';
import {
  getEnrichedTownsByCounty,
  computeMoversAndShakers,
  getTownSearchData,
} from '@utils/market-analysis';
import { getSortedCounties } from '../data/town-mappings';

// Get data at build time
const enrichedTownsByCounty = getEnrichedTownsByCounty();
const moversAndShakers = computeMoversAndShakers(6);
const townSearchData = getTownSearchData();
const sortedCounties = getSortedCounties();

// Generate breadcrumb schema
const breadcrumbSchema = generateBreadcrumbSchema([
  { name: 'Home', url: 'https://stevenfrato.com/' },
  { name: 'Service Areas', url: 'https://stevenfrato.com/areas/' },
]);

const title = 'Find Your Town | Burlington, Mercer & Middlesex Counties, NJ';
const description = "What's your home worth? Search your town to discover local market data, trends, and what homes are selling for in Burlington, Mercer, and Middlesex Counties.";
---

<BaseLayout title={title} description={description} schema={breadcrumbSchema}>
  <!-- Hero Section -->
  <section class="areas-hero">
    <div class="container">
      <h1>What's Your Home Worth?</h1>
      <p class="hero-subtitle">Find your town and discover what's happening in your local market</p>

      <div class="search-wrapper">
        <TownSearchIsland client:load towns={townSearchData} />
      </div>

      <div class="hero-stats">
        <div class="stat">
          <span class="stat-value">{Object.keys(enrichedTownsByCounty).length}</span>
          <span class="stat-label">Counties</span>
        </div>
        <div class="stat">
          <span class="stat-value">{townSearchData.length}+</span>
          <span class="stat-label">Towns</span>
        </div>
        <div class="stat">
          <span class="stat-value">Monthly</span>
          <span class="stat-label">Data Updates</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Movers & Shakers Section -->
  <MoversAndShakersSection
    hotMarkets={moversAndShakers.hotMarkets}
    fastMarkets={moversAndShakers.fastMarkets}
    competitiveMarkets={moversAndShakers.competitiveMarkets}
  />

  <!-- Browse by County Section -->
  <section class="browse-counties">
    <div class="container">
      <div class="section-header">
        <h2>Browse by County</h2>
        <p>Explore market data for every town I serve</p>
      </div>

      <div class="counties-grid">
        {sortedCounties.map((county) => {
          const towns = enrichedTownsByCounty[county] || [];
          const sellerCount = towns.filter((t) => t.marketType === 'seller').length;
          const avgPrice = towns.length > 0
            ? towns.reduce((sum, t) => sum + (t.medianPrice || 0), 0) / towns.filter((t) => t.medianPrice).length
            : null;

          return (
            <div class="county-section" id={county.toLowerCase().replace(/\s+/g, '-')}>
              <div class="county-header">
                <div class="county-title-row">
                  <h3>
                    <a href={`/market/${county.toLowerCase().replace(/\s+/g, '-')}/`} class="county-link">
                      {county}
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M9 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </a>
                  </h3>
                  {sellerCount > towns.length / 2 && (
                    <MarketTypeBadge type="seller" size="sm" />
                  )}
                </div>
                <div class="county-meta">
                  <span>{towns.length} towns</span>
                  {avgPrice && (
                    <>
                      <span class="separator">|</span>
                      <span>Avg. {new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(avgPrice)}</span>
                    </>
                  )}
                </div>
              </div>

              <div class="towns-grid">
                {towns.map((town) => (
                  <TownPreviewCard
                    name={town.name}
                    zipcode={town.zipcode}
                    county={town.county}
                    medianPrice={town.medianPrice}
                    priceYoY={town.priceYoY}
                    marketType={town.marketType}
                  />
                ))}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  </section>

  <!-- Lead Capture Section -->
  <section class="lead-capture-section" id="get-report">
    <div class="container">
      <MarketReportForm
        location="Central New Jersey"
        formName="market-report-areas"
      />
    </div>
  </section>

  <!-- CTA Box -->
  <section class="cta-section">
    <div class="container">
      <div class="cta-box">
        <h3>Don't see your town?</h3>
        <p>I likely still serve your area. Contact me for a personalized market analysis.</p>
        <a href="/contact/" class="btn btn-primary">Contact Me</a>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  /* Hero Section */
  .areas-hero {
    background: linear-gradient(135deg, var(--charcoal) 0%, #2a2a2a 100%);
    color: var(--white);
    padding: var(--space-12) 0 var(--space-10);
    text-align: center;
  }

  .areas-hero h1 {
    font-family: var(--font-heading);
    font-size: var(--text-4xl);
    margin-bottom: var(--space-3);
    line-height: 1.1;
  }

  .hero-subtitle {
    font-size: var(--text-lg);
    color: rgba(255, 255, 255, 0.85);
    max-width: 500px;
    margin: 0 auto var(--space-8);
  }

  .search-wrapper {
    max-width: 500px;
    margin: 0 auto var(--space-8);
  }

  .hero-stats {
    display: flex;
    justify-content: center;
    gap: var(--space-8);
    padding-top: var(--space-6);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  .stat {
    text-align: center;
  }

  .stat-value {
    display: block;
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--c21-gold);
  }

  .stat-label {
    font-size: var(--text-sm);
    color: rgba(255, 255, 255, 0.7);
  }

  /* Browse by County */
  .browse-counties {
    padding: var(--space-10) 0;
    background: var(--white);
  }

  .section-header {
    text-align: center;
    margin-bottom: var(--space-8);
  }

  .section-header h2 {
    font-family: var(--font-heading);
    font-size: var(--text-3xl);
    color: var(--text-primary);
    margin-bottom: var(--space-2);
  }

  .section-header p {
    font-size: var(--text-lg);
    color: var(--text-secondary);
  }

  .counties-grid {
    display: grid;
    gap: var(--space-10);
  }

  .county-section {
    padding-top: var(--space-6);
    border-top: 2px solid var(--c21-gold);
  }

  .county-header {
    margin-bottom: var(--space-5);
  }

  .county-title-row {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-2);
  }

  .county-title-row h3 {
    margin: 0;
    font-size: var(--text-xl);
  }

  .county-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    color: var(--text-primary);
    text-decoration: none;
    transition: color var(--transition-base);
  }

  .county-link:hover {
    color: var(--c21-gold);
  }

  .county-link svg {
    opacity: 0;
    transform: translateX(-4px);
    transition: all var(--transition-base);
  }

  .county-link:hover svg {
    opacity: 1;
    transform: translateX(0);
  }

  .county-meta {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    color: var(--text-secondary);
  }

  .county-meta .separator {
    color: var(--border-color);
  }

  .towns-grid {
    display: grid;
    gap: var(--space-4);
    grid-template-columns: repeat(2, 1fr);
  }

  @media (min-width: 768px) {
    .towns-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .towns-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  /* Lead Capture Section */
  .lead-capture-section {
    padding: var(--space-10) 0;
    background: var(--off-white);
  }

  /* CTA Section */
  .cta-section {
    padding: var(--space-8) 0 var(--space-12);
    background: var(--white);
  }

  .cta-box {
    padding: var(--space-8);
    background: linear-gradient(135deg, var(--charcoal) 0%, #2a2a2a 100%);
    border-radius: var(--radius-lg);
    text-align: center;
    color: var(--white);
  }

  .cta-box h3 {
    font-size: var(--text-2xl);
    margin-bottom: var(--space-3);
  }

  .cta-box p {
    font-size: var(--text-base);
    color: rgba(255, 255, 255, 0.85);
    margin-bottom: var(--space-6);
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
  }

  /* Responsive */
  @media (max-width: 640px) {
    .hero-stats {
      gap: var(--space-4);
    }

    .stat-value {
      font-size: var(--text-xl);
    }

    .towns-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
